<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="./iot_icon.ico" />
  <title>Smart City Admin</title>

  <!-- Leaflet CSS (core map styles) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin="anonymous"
  />
  <!-- MarkerCluster CSS (clusters for many accident markers) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <!-- App CSS (layout, legend, accident icons, pills) -->
  <link rel="stylesheet" href="../src/styles/base.css" />
  <link rel="stylesheet" href="../src/styles/layout.css" />
  <link rel="stylesheet" href="../src/styles/components.css" />
  <link rel="stylesheet" href="../src/styles/map.css" />
  
  <!-- Flatpickr (Date Range Picker) -->
  <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

</head>
<body>
  <!-- Topbar & Profile Menu (injected by layout.js) -->
  <div id="layout-header"></div>

  <!-- Main Content -->
  <main class="wrap">
    <section class="cards">
      <!-- Map Card -->
      <article class="card" id="map-card" style="grid-column: 1 / -1;">
        <h2>Live Map</h2>
        <div class="body">
          <div id="map" aria-label="Interactive city map"></div>
        </div>
        <div class="infobar" style="display:flex; gap: 1rem; align-items:center; flex-wrap:wrap; padding-top: 0.5rem;">
          
          <!-- Filters moved here -->
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <strong>Filters:</strong>
            <select id="timeRangeSelect" class="filter-input" style="padding: 0.4rem; border-radius: 4px; border: 1px solid #444; background: #222; color: #eee;">
              <option value="">Time Range...</option>
              <option value="15m">Last 15 Minutes</option>
              <option value="1h">Last 1 Hour</option>
              <option value="6h">Last 6 Hours</option>
              <option value="24h">Last 24 Hours</option>
              <option value="7d">Last 7 Days</option>
              <option value="custom">Custom Range</option>
            </select>
            
            <div id="customTimeContainer" style="display: none;">
              <input type="text" id="flatpickrRange" class="filter-input" placeholder="Select Date Range" style="width: 220px; padding: 0.4rem; border-radius: 4px; border: 1px solid #444; background: #222; color: #eee;" />
            </div>

            <button class="btn" id="btnClearTime" title="Clear Time Filter">Clear</button>
          </div>

          <div style="display: flex; align-items: center; gap: 0.5rem; border-left: 1px solid #444; padding-left: 1rem;">
              <label class="toggle-switch" title="Sync with Map View">
                <input type="checkbox" id="filterLocationToggle">
                <span class="slider"></span>
              </label>
              <span style="font-size: 0.9rem;">Sync Map</span>
          </div>

          <div style="flex: 1;"></div> <!-- Spacer -->

          <button class="btn" id="locBtn">Center on Patras</button>
          <span class="pill" id="apiStatus" title="Backend connectivity">API: checking...</span>
          <button class="btn" id="btnRefreshNow" title="Refresh accidents now">Refresh now</button>
        </div>
      </article>

      <!-- Grafana Card -->
      <article class="card" id="grafana-card" style="grid-column: 1 / -1;">
        <h2>Analytics (Grafana)</h2>
        <div class="body grafana-grid">
          <iframe
            class="grafana-embed"
            id="grafanaFrame"
            title="Grafana"
            src="https://labserver.sense-campus.gr:8087/d-solo/af3sxa571x79cc/group9-traffic?timezone=browser&var-location=&var-lat=&var-lng=&showCategory=Override%201&orgId=2&panelId=1&__feature.dashboardSceneSolo=false"
            width="100%"
            height="420"
            frameborder="0"
          ></iframe>
          <iframe
            class="grafana-embed"
            title="Parking Grafana"
            src="https://labserver.sense-campus.gr:8087/d-solo/af3sxa571x79cc/group9-traffic?timezone=browser&var-min_lat=-90&var-max_lat=90&var-min_lng=-180&var-max_lng=180&refresh=30s&orgId=2&panelId=2&__feature.dashboardSceneSolo=false"
            width="100%"
            height="420"
            frameborder="0"
          ></iframe>
          <iframe
            class="grafana-embed"
            title="Traffic Distribution"
            src="https://labserver.sense-campus.gr:8087/d-solo/af3sxa571x79cc/group9-traffic?timezone=browser&var-location=&var-lat=&var-lng=&orgId=2&panelId=3&__feature.dashboardSceneSolo=false"
            width="450"
            height="200"
            frameborder="0"
          ></iframe>
          <iframe
            class="grafana-embed"
            title="Violations Overview"
            src="https://labserver.sense-campus.gr:8087/d-solo/af3sxa571x79cc/group9-traffic?timezone=browser&var-location=&var-lat=&var-lng=&orgId=2&panelId=4&__feature.dashboardSceneSolo=false"
            width="450"
            height="200"
            frameborder="0"
          ></iframe>
        </div>
      </article>

      <!-- LLM Card -->
      <article class="card" id="llm-card" style="grid-column: 1 / -1;">
        <h2>AI City Analyst</h2>
        <div class="body">
          <div style="display:flex; gap:.5rem; margin-bottom:.5rem; align-items:center;">
            <p style="flex: 1; color: var(--muted); margin: 0;">
              Generate an AI report based on the current map view and selected time range.
            </p>
            <button class="btn" id="llmAnalyzeBtn" aria-label="Analyze Visible Area">Analyze Visible Area</button>
          </div>
          <div
            id="llmOutput"
            style="min-height:160px;border:1px dashed rgba(79,209,197,.35);border-radius:10px;padding:1rem;color:var(--muted);white-space:pre-wrap"
            aria-live="polite"
          >Select a time range and map area, then click Analyze.</div>
        </div>
        <div class="infobar">
          <span class="pill" id="llmStatus">Ready</span>
        </div>
      </article>
    </section>
  </main>

  <!-- Leaflet JS (map engine) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="anonymous"
  ></script>
  <!-- MarkerCluster JS (client-side spatial clustering for markers) -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Configure backend API base for Live Server (adjust if backend runs elsewhere).
       The map code (map.js) reads window.APP_API_BASE to poll recent accidents. -->
  <script>
    window.APP_API_BASE = window.APP_API_BASE || 'http://localhost:8000';
    // LLM backend proxy defaults (override as needed)
    // If you run the standalone LLM server (api/llm_server.py), default to 9090
    window.LLM_BACKEND_BASE = window.LLM_BACKEND_BASE || 'http://localhost:9090';
    window.LLM_MODEL        = window.LLM_MODEL        || 'deepseek-r1:8b';
  </script>

  <!-- Main App Script (initializes auth/map/grafana/llm modules) -->
  <script type="module">
    import { initLayout } from '/src/js/layout.js';
    initLayout();
  </script>
  <script type="module" src="../src/js/app.js?v=7"></script>

  <!-- STANDALONE LLM SCRIPT (Bypasses Module Loading Issues) -->
  <script>
    (function() {
        console.log("Standalone LLM Script: Initializing...");
        
        const btn = document.getElementById('llmAnalyzeBtn');
        const output = document.getElementById('llmOutput');
        const statusPill = document.getElementById('llmStatus');
        const LLM_BACKEND = window.LLM_BACKEND_BASE || 'http://localhost:9090';

        // Activate Analyze Button
        if (btn) {
            btn.onclick = async function() {
                console.log("Analyze Button Clicked (Standalone)");
                
                if (btn.disabled) return;

                // Check if map is ready
                if (!window.map) {
                    alert("Map is not fully loaded yet. Please wait a moment.");
                    return;
                }

                // UI Loading State
                btn.disabled = true;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="spinner"></span> Analyzing...';
                if (statusPill) {
                    statusPill.textContent = 'Processing';
                    statusPill.className = 'pill warn';
                }
                if (output) {
                    output.innerHTML = '<div style="color:#888; text-align:center; padding: 20px;">Gathering data from visible area...</div>';
                }

                try {
                    // Gather Data
                    const bounds = window.map.getBounds();
                    // Try to get filters from window if available, else default
                    const filters = window.getMapFilters ? window.getMapFilters() : {};
                    
                    const payload = {
                        startTime: filters.start || '-1h',
                        endTime: filters.end || 'now()',
                        bounds: {
                            north: bounds.getNorth(),
                            south: bounds.getSouth(),
                            east: bounds.getEast(),
                            west: bounds.getWest()
                        }
                    };

                    console.log('Sending payload:', payload);

                    const res = await fetch(`${LLM_BACKEND}/api/llm/analyze`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const text = await res.text();
                    let data = {};
                    try { data = JSON.parse(text); } catch(e) {}

                    if (!res.ok) {
                        throw new Error(data.error || data.message || `HTTP ${res.status}`);
                    }

                    const report = data.output || data.text || text;
                    if (output) output.innerHTML = report.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');

                } catch (err) {
                    console.error('LLM Error:', err);
                    if (output) output.innerHTML = `<div style="color:#e74c3c; padding: 10px; border: 1px solid #e74c3c; border-radius: 4px;"><strong>Error:</strong> ${err.message}</div>`;
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    if (statusPill) {
                        statusPill.textContent = 'Ready';
                        statusPill.className = 'pill';
                    }
                }
            };
            console.log("Standalone LLM Script: Analyze Button Activated");
        } else {
            console.error("Standalone LLM Script: Analyze Button NOT found in DOM");
        }
    })();
  </script>
</body>
</html>
